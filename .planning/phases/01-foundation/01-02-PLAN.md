---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [.upsun/config.yaml, .env.local, package.json]
---

<objective>
Deploy Next.js app to Upsun with environment configuration.

Purpose: Establish production deployment pipeline from day one.
Output: Live site on Upsun with Sanity environment variables configured.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Constraint from PROJECT.md:**
- Hosting: Upsun.com — platform must be compatible
- Next.js 14 is fully supported by Upsun

**Upsun Next.js support:**
- Automatic Node.js detection
- Build command: npm run build
- Start command: npm start
- Environment variables via Upsun console or CLI
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Upsun configuration</name>
  <files>.upsun/config.yaml</files>
  <action>
Create .upsun/config.yaml for Next.js deployment:

```yaml
applications:
  web:
    source:
      root: "/"
    type: "nodejs:20"

    build:
      flavor: none

    hooks:
      build: |
        set -e
        npm ci
        npm run build

    web:
      commands:
        start: npm start
      locations:
        "/":
          passthru: true

    mounts:
      ".next/cache":
        source: "local"
        source_path: "cache"

routes:
  "https://{default}/":
    type: upstream
    upstream: "web:http"
  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"
```

This configuration:
- Uses Node.js 20 LTS
- Runs npm ci + npm run build during deploy
- Mounts .next/cache for incremental builds
- Redirects www to non-www
  </action>
  <verify>File exists with valid YAML syntax: `cat .upsun/config.yaml | head -20`</verify>
  <done>.upsun/config.yaml created with Next.js-optimized settings</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Sanity project and configure environment variables</action>
  <instructions>
I've prepared the Upsun config. Before deployment, you need to:

1. **Create Sanity project** (if not done):
   - Go to https://sanity.io/manage
   - Create new project named "digitalist"
   - Copy the Project ID

2. **Create local .env.local**:
   ```bash
   cp .env.local.example .env.local
   ```
   Then edit .env.local with your Sanity Project ID

3. **Verify Sanity studio works locally**:
   ```bash
   npm run dev
   ```
   Visit http://localhost:3000/studio — should load without errors
  </instructions>
  <verification>Sanity studio at /studio loads and shows project name "Digitalist CMS"</verification>
  <resume-signal>Type "done" when Sanity is configured and studio works locally</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Deploy to Upsun</name>
  <files>package.json</files>
  <action>
Initialize Upsun project and deploy:

```bash
# Login to Upsun (if not already)
upsun auth:login

# Initialize project (creates .upsun/local/project.yaml)
upsun project:init

# Set environment variables
upsun variable:create --name NEXT_PUBLIC_SANITY_PROJECT_ID --value "$SANITY_PROJECT_ID" --level environment --visible-build true --visible-runtime true
upsun variable:create --name NEXT_PUBLIC_SANITY_DATASET --value "production" --level environment --visible-build true --visible-runtime true

# Deploy
upsun push
```

If upsun CLI not installed, install with:
```bash
curl -fsSL https://raw.githubusercontent.com/platformsh/cli/main/installer.sh | bash
```

Note: First deploy may take 3-5 minutes as Upsun provisions infrastructure.
  </action>
  <verify>`upsun url` shows the live URL, curl returns 200</verify>
  <done>Site deployed to Upsun with working build pipeline</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Deployed Next.js site to Upsun with Sanity configuration</what-built>
  <how-to-verify>
    1. Run: `upsun url` to get the live URL
    2. Visit the main URL — should show "Digitalist.se" placeholder
    3. Visit {url}/studio — Sanity studio should load
    4. Visit {url}/en — English locale should work
    5. Check: No console errors, site loads fast
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .upsun/config.yaml exists and is valid
- [ ] Site is live on Upsun URL
- [ ] Sanity studio accessible at /studio
- [ ] i18n routing works (/, /en)
- [ ] Build completes without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Production deployment pipeline established
- Sanity environment configured in Upsun
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
