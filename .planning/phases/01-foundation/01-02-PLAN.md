---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [.upsun/config.yaml, directus/Dockerfile, directus/package.json, directus/.env.example]
---

<objective>
Deploy Next.js + Directus as multi-app on Upsun with PostgreSQL.

Purpose: Establish production deployment pipeline with self-hosted CMS.
Output: Live site on Upsun with Directus admin at /directus subdomain.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Arkitekturbeslut:**

- Multi-app setup: Next.js (frontend) + Directus (cms) på samma Upsun-projekt
- PostgreSQL som delad databastjänst
- Directus assets på Upsun disk mount
- Fast API-token för Next.js → Directus kommunikation

**Upsun multi-app struktur:**

```
/
├── .upsun/config.yaml    # Multi-app configuration
├── directus/             # Directus app
│   ├── Dockerfile
│   ├── package.json
│   └── .env.example
└── (Next.js files)       # Frontend app (root)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Directus app directory with configuration</name>
  <files>directus/package.json, directus/.env.example, directus/extensions/.gitkeep</files>
  <action>
Create directus/package.json:

```json
{
  "name": "digitalist-cms",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "directus start",
    "bootstrap": "directus bootstrap"
  },
  "dependencies": {
    "directus": "^11.0.0",
    "pg": "^8.11.0"
  }
}
```

Create directus/.env.example:

```
# Database (populated by Upsun)
DB_CLIENT=pg
DB_HOST=database.internal
DB_PORT=5432
DB_DATABASE=main
DB_USER=main
DB_PASSWORD=

# Security
SECRET=replace-with-random-secret
ADMIN_EMAIL=admin@digitalist.se
ADMIN_PASSWORD=replace-with-secure-password

# Server
HOST=0.0.0.0
PORT=8055
PUBLIC_URL=https://cms.digitalist.se

# Storage (local disk on Upsun)
STORAGE_LOCATIONS=local
STORAGE_LOCAL_DRIVER=local
STORAGE_LOCAL_ROOT=/app/uploads

# API Token for Next.js frontend
FRONTEND_API_TOKEN=replace-with-generated-token
```

Create directus/extensions/.gitkeep (empty file for extensions directory).
  </action>
  <verify>Files exist: ls directus/</verify>
  <done>Directus app directory with package.json and env template</done>
</task>

<task type="auto">
  <name>Task 2: Create Upsun multi-app configuration</name>
  <files>.upsun/config.yaml</files>
  <action>
Create .upsun/config.yaml for multi-app deployment:

```yaml
applications:
  # Next.js Frontend
  frontend:
    source:
      root: "/"
    type: "nodejs:20"

    build:
      flavor: none

    hooks:
      build: |
        set -e
        npm ci
        npm run build

    web:
      commands:
        start: npm start
      locations:
        "/":
          passthru: true

    mounts:
      ".next/cache":
        source: "local"
        source_path: "cache"

    relationships:
      directus: "cms:http"

  # Directus CMS
  cms:
    source:
      root: "directus"
    type: "nodejs:20"

    build:
      flavor: none

    hooks:
      build: |
        set -e
        npm ci
      deploy: |
        set -e
        npx directus bootstrap

    web:
      commands:
        start: npm start
      locations:
        "/":
          passthru: true

    mounts:
      "uploads":
        source: "local"
        source_path: "uploads"
      "extensions":
        source: "local"
        source_path: "extensions"

    relationships:
      database: "db:postgresql"

services:
  db:
    type: "postgresql:16"

routes:
  # Main site
  "https://{default}/":
    type: upstream
    upstream: "frontend:http"

  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"

  # Directus CMS admin
  "https://cms.{default}/":
    type: upstream
    upstream: "cms:http"
```

This configuration:

- Runs Next.js on main domain
- Runs Directus on cms.{domain} subdomain
- PostgreSQL 16 as shared database service
- Disk mounts for Directus uploads and Next.js cache
- Internal relationship so frontend can reach Directus
  </action>
  <verify>cat .upsun/config.yaml shows valid YAML with two applications</verify>
  <done>Multi-app Upsun config with Next.js, Directus, and PostgreSQL</done>
</task>

<task type="auto">
  <name>Task 3: Deploy to Upsun and configure environment</name>
  <files>.env.local</files>
  <action>
Initialize and deploy to Upsun:

```bash
# Login to Upsun (if not already)
upsun auth:login

# Create project (interactive - choose region, etc.)
upsun project:create --title "Digitalist.se" --region "eu-5.platform.sh"

# Set Directus secrets as environment variables
upsun variable:create --name SECRET --value "$(openssl rand -hex 32)" --level environment --sensitive true
upsun variable:create --name ADMIN_EMAIL --value "admin@digitalist.se" --level environment
upsun variable:create --name ADMIN_PASSWORD --value "$(openssl rand -base64 16)" --level environment --sensitive true
upsun variable:create --name FRONTEND_API_TOKEN --value "$(openssl rand -hex 32)" --level environment --sensitive true

# Deploy
upsun push
```

After deployment, get the API token and update local .env.local:

```bash
# Get the token value
upsun variable:get FRONTEND_API_TOKEN

# Update .env.local with production values for local dev
cp .env.local.example .env.local
# Edit .env.local with:
# DIRECTUS_URL=https://cms.{your-upsun-domain}
# DIRECTUS_API_TOKEN={the-token-value}
```

Note: First deploy provisions PostgreSQL and runs Directus bootstrap to create admin user.
  </action>
  <verify>upsun url shows both frontend and cms URLs</verify>
  <done>Upsun project deployed with both apps running</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Multi-app deployment with Next.js frontend and Directus CMS on Upsun</what-built>
  <how-to-verify>
    1. Run: `upsun url` to get the live URLs
    2. Visit main URL — should show "Digitalist.se" placeholder
    3. Visit cms.{domain} — Directus login should appear
    4. Log in with admin@digitalist.se and the generated password
       (get password: `upsun variable:get ADMIN_PASSWORD`)
    5. Verify Directus admin dashboard loads
    6. Visit main URL/en — English locale should work
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:

- [ ] .upsun/config.yaml exists with multi-app setup
- [ ] directus/ directory has package.json and config
- [ ] Both apps deployed and accessible
- [ ] Directus admin UI works at cms.{domain}
- [ ] PostgreSQL connected and Directus bootstrapped
- [ ] Frontend can reach Directus (relationship configured)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Production deployment pipeline established
- Directus CMS running self-hosted on Upsun
- Ready for design system setup (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
